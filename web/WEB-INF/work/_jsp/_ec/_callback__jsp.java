/*
 * JSP generated by Resin-4.0.58 (built Fri, 24 Aug 2018 01:23:14 PDT)
 */

package _jsp._ec;
import javax.servlet.*;
import javax.servlet.jsp.*;
import javax.servlet.http.*;
import com.yeepay.PaymentForOnlineService;
import com.yeepay.Configuration;
import com.bizwink.util.SpringInit;
import org.springframework.context.ApplicationContext;
import com.bizwink.mysql.service.MEcService;
import java.sql.Timestamp;
import java.text.SimpleDateFormat;
import java.util.Date;

public class _callback__jsp extends com.caucho.jsp.JavaPage
{
  private static final java.util.HashMap<String,java.lang.reflect.Method> _jsp_functionMap = new java.util.HashMap<String,java.lang.reflect.Method>();
  private boolean _caucho_isDead;
  private boolean _caucho_isNotModified;
  private com.caucho.jsp.PageManager _jsp_pageManager;

  	String formatString(String text){
  			if(text == null) {
  				return ""; 
  			}
  			return text;
  		}

  
  public void
  _jspService(javax.servlet.http.HttpServletRequest request,
              javax.servlet.http.HttpServletResponse response)
    throws java.io.IOException, javax.servlet.ServletException
  {
    javax.servlet.http.HttpSession session = request.getSession(true);
    com.caucho.server.webapp.WebApp _jsp_application = _caucho_getApplication();
    com.caucho.jsp.PageContextImpl pageContext = _jsp_pageManager.allocatePageContext(this, _jsp_application, request, response, null, session, 8192, true, false);

    TagState _jsp_state = null;

    try {
      _jspService(request, response, pageContext, _jsp_application, session, _jsp_state);
    } catch (java.lang.Throwable _jsp_e) {
      pageContext.handlePageException(_jsp_e);
    } finally {
      _jsp_pageManager.freePageContext(pageContext);
    }
  }
  
  private void
  _jspService(javax.servlet.http.HttpServletRequest request,
              javax.servlet.http.HttpServletResponse response,
              com.caucho.jsp.PageContextImpl pageContext,
              javax.servlet.ServletContext application,
              javax.servlet.http.HttpSession session,
              TagState _jsp_state)
    throws Throwable
  {
    javax.servlet.jsp.JspWriter out = pageContext.getOut();
    final javax.el.ELContext _jsp_env = pageContext.getELContext();
    javax.servlet.ServletConfig config = getServletConfig();
    javax.servlet.Servlet page = this;
    javax.servlet.jsp.tagext.JspTag _jsp_parent_tag = null;
    com.caucho.jsp.PageContextImpl _jsp_parentContext = pageContext;
    response.setContentType("text/html;charset=GBK");

    out.write(_jsp_string0, 0, _jsp_string0.length);
    
	String keyValue   = formatString(Configuration.getInstance().getValue("keyValue"));                            // \u5546\u5bb6\u5bc6\u94a5
	String r0_Cmd 	  = formatString(request.getParameter("r0_Cmd"));                                              // \u4e1a\u52a1\u7c7b\u578b
	String p1_MerId   = formatString(Configuration.getInstance().getValue("p1_MerId"));                            // \u5546\u6237\u7f16\u53f7
	String r1_Code    = formatString(request.getParameter("r1_Code"));                                             // \u652f\u4ed8\u7ed3\u679c
	String r2_TrxId   = formatString(request.getParameter("r2_TrxId"));                                            // \u6613\u5b9d\u652f\u4ed8\u4ea4\u6613\u6d41\u6c34\u53f7
	String r3_Amt     = formatString(request.getParameter("r3_Amt"));                                              // \u652f\u4ed8\u91d1\u989d
	String r4_Cur     = formatString(request.getParameter("r4_Cur"));                                              // \u4ea4\u6613\u5e01\u79cd
	String r5_Pid     = new String(formatString(request.getParameter("r5_Pid")).getBytes("iso-8859-1"),"gbk");  // \u5546\u54c1\u540d\u79f0
	String r6_Order   = formatString(request.getParameter("r6_Order"));                                            // \u5546\u6237\u8ba2\u5355\u53f7
	String r7_Uid     = formatString(request.getParameter("r7_Uid"));                                              // \u6613\u5b9d\u652f\u4ed8\u4f1a\u5458ID
	String r8_MP      = new String(formatString(request.getParameter("r8_MP")).getBytes("iso-8859-1"),"gbk");   // \u5546\u6237\u6269\u5c55\u4fe1\u606f
	String r9_BType   = formatString(request.getParameter("r9_BType"));                                            // \u4ea4\u6613\u7ed3\u679c\u8fd4\u56de\u7c7b\u578b,1\u6d4f\u89c8\u5668\u91cd\u5b9a\u5411 2\u670d\u52a1\u5668\u70b9\u5bf9\u70b9
	String hmac       = formatString(request.getParameter("hmac"));                                                // \u7b7e\u540d\u6570\u636e
    String rp_PayDate = formatString(request.getParameter("rp_PayDate"));                                         //\u652f\u4ed8\u6210\u529f\u65f6\u95f4
    String ru_Trxtime = formatString(request.getParameter("ru_Trxtime"));                                         //\u652f\u4ed8\u72b6\u6001\u901a\u77e5\u65f6\u95f4

    boolean isOK = false;
	// \u6821\u9a8c\u8fd4\u56de\u6570\u636e\u5305
	isOK = PaymentForOnlineService.verifyCallback(hmac,p1_MerId,r0_Cmd,r1_Code,r2_TrxId,r3_Amt,r4_Cur,r5_Pid,r6_Order,r7_Uid,r8_MP,r9_BType,keyValue);
	if(isOK) {
		//\u5728\u63a5\u6536\u5230\u652f\u4ed8\u7ed3\u679c\u901a\u77e5\u540e\uff0c\u5224\u65ad\u662f\u5426\u8fdb\u884c\u8fc7\u4e1a\u52a1\u903b\u8f91\u5904\u7406\uff0c\u4e0d\u8981\u91cd\u590d\u8fdb\u884c\u4e1a\u52a1\u903b\u8f91\u5904\u7406
        ApplicationContext appContext = SpringInit.getApplicationContext();
        MEcService mEcService = null;
        if(r1_Code.equals("1")) {
            long orderid = Long.parseLong(r6_Order);
            if (appContext!=null)
                mEcService = (MEcService)appContext.getBean("MEcService");
            else {
                response.sendRedirect("/error.jsp?errcode=-1");
                return;
            }
			// \u4ea7\u54c1\u901a\u7528\u63a5\u53e3\u652f\u4ed8\u6210\u529f\u8fd4\u56de-\u6d4f\u89c8\u5668\u91cd\u5b9a\u5411
            SimpleDateFormat format=new SimpleDateFormat("yyyyMMddhhmmss");
			if(r9_BType.equals("1")) {
                //UpdatePayflag(long orderid,String jylsh,String zfmemberid,int r2type,String payresult,int payflag)
                //\u53c2\u65701\uff1a\u8ba2\u5355\u53f7
                //\u53c2\u65702\uff1a\u7b2c\u4e09\u65b9\u652f\u4ed8\u670d\u52a1\u7684\u4ea4\u6613\u6d41\u6c34\u53f7
                //\u53c2\u65703\uff1a\u652f\u4ed8\u5546\u6237\u53f7
                //\u53c2\u65704\uff1a\u652f\u4ed8\u4ea4\u6613\u7c7b\u578b
                //\u53c2\u65705\uff1a\u652f\u4ed8\u8fd4\u56de\u7801
                //\u53c2\u65706\uff1a1\u8868\u793a\u5df2\u7ecf\u5b8c\u6210\u652f\u4ed8
                //\u53c2\u65707\uff1a\u4ee3\u8868\u662f\u7b2c\u4e09\u65b9\u652f\u4ed8\u7f16\u53f7\uff0c0--\u5fae\u4fe1  2--\u94f6\u884c 1-\u652f\u4ed8\u5b9d
                Date pay_sucess_date = format.parse(rp_PayDate);
                mEcService.UpdatePayflag(orderid,r2_TrxId,r7_Uid,r9_BType,r1_Code,1,2,new Timestamp(pay_sucess_date.getTime()));
                out.println("<script   lanugage=\"javascript\">alert(\"\u652f\u4ed8\u6210\u529f\uff01\");window.close();</script>");
				//out.println("callback\u65b9\u5f0f:\u4ea7\u54c1\u901a\u7528\u63a5\u53e3\u652f\u4ed8\u6210\u529f\u8fd4\u56de-\u6d4f\u89c8\u5668\u91cd\u5b9a\u5411");
				// \u4ea7\u54c1\u901a\u7528\u63a5\u53e3\u652f\u4ed8\u6210\u529f\u8fd4\u56de-\u670d\u52a1\u5668\u70b9\u5bf9\u70b9\u901a\u8baf
			} else if(r9_BType.equals("2")) {
				// \u5982\u679c\u5728\u53d1\u8d77\u4ea4\u6613\u8bf7\u6c42\u65f6	\u8bbe\u7f6e\u4f7f\u7528\u5e94\u7b54\u673a\u5236\u65f6\uff0c\u5fc5\u987b\u5e94\u7b54\u4ee5"success"\u5f00\u5934\u7684\u5b57\u7b26\u4e32\uff0c\u5927\u5c0f\u5199\u4e0d\u654f\u611f
                //orderMgr.updateStatus(id,4,"");
                //\u53c2\u65701\uff1a\u8ba2\u5355\u53f7
                //\u53c2\u65702\uff1a\u7b2c\u4e09\u65b9\u652f\u4ed8\u670d\u52a1\u7684\u4ea4\u6613\u6d41\u6c34\u53f7
                //\u53c2\u65703\uff1a\u652f\u4ed8\u5546\u6237\u53f7
                //\u53c2\u65704\uff1a\u652f\u4ed8\u4ea4\u6613\u7c7b\u578b
                //\u53c2\u65705\uff1a\u652f\u4ed8\u8fd4\u56de\u7801
                //\u53c2\u65706\uff1a1\u8868\u793a\u5df2\u7ecf\u5b8c\u6210\u652f\u4ed8
                //\u53c2\u65707\uff1a\u4ee3\u8868\u662f\u7b2c\u4e09\u65b9\u652f\u4ed8\u7f16\u53f7\uff0c0--\u5fae\u4fe1  2--\u94f6\u884c 1-\u652f\u4ed8\u5b9d
                Date pay_sucess_date = format.parse(rp_PayDate);
                mEcService.UpdatePayflag(orderid,r2_TrxId,r7_Uid,r9_BType,r1_Code,1,2,new Timestamp(pay_sucess_date.getTime()));
				out.println("SUCCESS");
			  // \u4ea7\u54c1\u901a\u7528\u63a5\u53e3\u652f\u4ed8\u6210\u529f\u8fd4\u56de-\u7535\u8bdd\u652f\u4ed8\u8fd4\u56de		
			}
			// \u4e0b\u9762\u9875\u9762\u8f93\u51fa\u662f\u6d4b\u8bd5\u65f6\u89c2\u5bdf\u7ed3\u679c\u4f7f\u7528
			//out.println("<br>\u4ea4\u6613\u6210\u529f!<br>\u5546\u5bb6\u8ba2\u5355\u53f7:" + r6_Order + "<br>\u652f\u4ed8\u91d1\u989d:" + r3_Amt + "<br>\u6613\u5b9d\u652f\u4ed8\u4ea4\u6613\u6d41\u6c34\u53f7:" + r2_TrxId);
		}
	} else {
		out.println("\u4ea4\u6613\u7b7e\u540d\u88ab\u7be1\u6539!");
	}

  }

  private com.caucho.make.DependencyContainer _caucho_depends
    = new com.caucho.make.DependencyContainer();

  public java.util.ArrayList<com.caucho.vfs.Dependency> _caucho_getDependList()
  {
    return _caucho_depends.getDependencies();
  }

  public void _caucho_addDepend(com.caucho.vfs.PersistentDependency depend)
  {
    super._caucho_addDepend(depend);
    _caucho_depends.add(depend);
  }

  protected void _caucho_setNeverModified(boolean isNotModified)
  {
    _caucho_isNotModified = true;
  }

  public boolean _caucho_isModified()
  {
    if (_caucho_isDead)
      return true;

    if (_caucho_isNotModified)
      return false;

    if (com.caucho.server.util.CauchoSystem.getVersionId() != 6165118203484593848L)
      return true;

    return _caucho_depends.isModified();
  }

  public long _caucho_lastModified()
  {
    return 0;
  }

  public void destroy()
  {
      _caucho_isDead = true;
      super.destroy();
    TagState tagState;
  }

  public void init(com.caucho.vfs.Path appDir)
    throws javax.servlet.ServletException
  {
    com.caucho.vfs.Path resinHome = com.caucho.server.util.CauchoSystem.getResinHome();
    com.caucho.vfs.MergePath mergePath = new com.caucho.vfs.MergePath();
    mergePath.addMergePath(appDir);
    mergePath.addMergePath(resinHome);
    com.caucho.loader.DynamicClassLoader loader;
    loader = (com.caucho.loader.DynamicClassLoader) getClass().getClassLoader();
    String resourcePath = loader.getResourcePathSpecificFirst();
    mergePath.addClassPath(resourcePath);
    com.caucho.vfs.Depend depend;
    depend = new com.caucho.vfs.Depend(appDir.lookup("ec/callback.jsp"), -5431719345779196918L, false);
    _caucho_depends.add(depend);
    loader.addDependency(depend);
  }

  final static class TagState {

    void release()
    {
    }
  }

  public java.util.HashMap<String,java.lang.reflect.Method> _caucho_getFunctionMap()
  {
    return _jsp_functionMap;
  }

  public void caucho_init(ServletConfig config)
  {
    try {
      com.caucho.server.webapp.WebApp webApp
        = (com.caucho.server.webapp.WebApp) config.getServletContext();
      init(config);
      if (com.caucho.jsp.JspManager.getCheckInterval() >= 0)
        _caucho_depends.setCheckInterval(com.caucho.jsp.JspManager.getCheckInterval());
      _jsp_pageManager = webApp.getJspApplicationContext().getPageManager();
      com.caucho.jsp.TaglibManager manager = webApp.getJspApplicationContext().getTaglibManager();
      com.caucho.jsp.PageContextImpl pageContext = new com.caucho.jsp.InitPageContextImpl(webApp, this);
    } catch (Exception e) {
      throw com.caucho.config.ConfigException.create(e);
    }
  }

  private final static char []_jsp_string0;
  static {
    _jsp_string0 = "\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n".toCharArray();
  }
}
